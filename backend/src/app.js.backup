const express = require('express');
const cors = require('cors');
const path = require('path');
const { sequelize } = require('./models');
const authRoutes = require('./routes/auth');
const adminRoutes = require('./routes/admin');
const messageRoutes = require('./routes/messageRoutes');
const formationsRoutes = require('./routes/formations');
const congesPermissionsRoutes = require('./routes/congesPermissionsRoutes');
const formateurRoutes = require('./routes/formateurRoutes');
const inscriptionsRoutes = require('./routes/inscriptions');
const ateliersRoutes = require('./routes/ateliers');
const config = require('./config/config');

// Importer les mod√®les
require('./models/User');
require('./models/Message');
require('./models/Cours');

const app = express();

// Configuration CORS
app.use(cors({
  origin: 'http://localhost:3000',
  credentials: true,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization']
}));

// Middleware pour parser le JSON
app.use(express.json());

// Servir les fichiers upload√©s
app.use('/uploads', express.static(path.join(__dirname, '../uploads')));

// Routes
app.use('/api/auth', authRoutes);
app.use('/api/admin', adminRoutes);
app.use('/api/messages', messageRoutes);
app.use('/api/formations', formationsRoutes);
app.use('/api/conges-permissions', congesPermissionsRoutes);
app.use('/api/formateur', formateurRoutes);
app.use('/api/inscriptions', inscriptionsRoutes); // Ajout de la route des inscriptions
app.use('/api/ateliers', ateliersRoutes); // Ateliers publics et prot√©g√©s

// Page d'accueil informative
app.get('/', (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html lang="fr">
      <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>API Gestion des Formations</title>
        <style>
          body { font-family: Arial, sans-serif; max-width: 900px; margin: 40px auto; color: #2c3e50; }
          h1 { color: #34495e; }
          .endpoint { background: #f8f9fa; padding: 12px 16px; border-radius: 6px; margin: 10px 0; border-left: 4px solid #3498db; }
          .method { display: inline-block; padding: 2px 8px; border-radius: 4px; color: #fff; font-weight: 600; font-size: 12px; margin-right: 8px; }
          .get { background: #2ecc71; } .post { background: #3498db; } .put { background: #f39c12; } .delete { background: #e74c3c; }
          a { color: #2980b9; text-decoration: none; } a:hover { text-decoration: underline; }
        </style>
      </head>
      <body>
        <h1>API Gestion des Formations</h1>
        <p>Bienvenue. Le serveur est en cours d'ex√©cution. Endpoints principaux:</p>
        <div class="endpoint"><span class="method get">GET</span><a href="/api/status">/api/status</a> - Statut API</div>
        <div class="endpoint"><span class="method post">POST</span>/api/auth/login - Connexion</div>
        <div class="endpoint"><span class="method post">POST</span>/api/auth/register - Inscription</div>
        <div class="endpoint"><span class="method get">GET</span>/api/formations - Formations</div>
        <div class="endpoint"><span class="method get">GET</span>/api/admin/stats - Statistiques (admin)</div>
        <div class="endpoint"><span class="method get">GET</span>/api/inscriptions - Inscriptions (admin)</div>
      </body>
    </html>
  `);
});

// Route temporaire pour les cours (solution de contournement)
app.get('/api/cours', async (req, res) => {
  try {
    console.log('üìö Route /api/cours appel√©e');
    const { Cours, Formation, User } = require('./models');
    
    const cours = await Cours.findAll({
      where: { type: 'pdf' },
      include: [
        {
          model: Formation,
          as: 'formation',
          attributes: ['id', 'titre']
        },
        {
          model: User,
          as: 'Formateur',
          attributes: ['id', 'nom', 'prenom']
        }
      ],
      order: [['createdAt', 'DESC']]
    });

    console.log(`‚úÖ ${cours.length} cours trouv√©s`);
    res.status(200).json(cours);
  } catch (error) {
    console.error('‚ùå Erreur:', error);
    res.status(500).json({ message: 'Erreur serveur', error: error.message });
  }
});

// Route de test
app.get('/api/status', (req, res) => {
  res.json({ status: 'API fonctionnelle', timestamp: new Date() });
});

// Servir les fichiers statiques en production
if (process.env.NODE_ENV === 'production') {
  app.use(express.static(path.join(__dirname, '../../gestion-formations-cfp-frontend/build')));
  
  app.get('*', (req, res) => {
    res.sendFile(path.resolve(__dirname, '../../gestion-formations-cfp-frontend/build', 'index.html'));
  });
}

// Gestion des erreurs 404
app.use((req, res, next) => {
  // Si la requ√™te est pour l'API, renvoyer une erreur JSON
  if (req.originalUrl.startsWith('/api/')) {
    return res.status(404).json({ error: 'Route API non trouv√©e' });
  }
  // Sinon, laisser le gestionnaire de routage React g√©rer la route
  next();
});

// Gestion des erreurs globales
app.use((err, req, res, next) => {
  console.error('Erreur:', err);
  res.status(500).json({ 
    error: err.message || 'Une erreur est survenue sur le serveur' 
  });
});

const PORT = process.env.PORT ? Number(process.env.PORT) : 5002;

// Fonction pour cr√©er un utilisateur admin par d√©faut
const createDefaultUser = async () => {
  try {
    const { User } = require('./models');
    const adminExists = await User.findOne({ where: { email: 'admin@cfp.com' } });
    
    if (!adminExists) {
      const bcrypt = require('bcryptjs');
      const salt = await bcrypt.genSalt(10);
      const hashedPassword = await bcrypt.hash('admin123', salt);
      
      await User.create({
        nom: 'Admin',
        prenom: 'Administrateur',
        email: 'admin@cfp.com',
        password: hashedPassword,
        role: 'admin',
        statut: 'actif',
        emailVerifie: true
      });
      console.log('‚úÖ Compte administrateur cr√©√© avec succ√®s');
    }
  } catch (error) {
    console.error('‚ùå Erreur lors de la cr√©ation du compte admin:', error);
  }
};

// D√©marrage du serveur
const startServer = async () => {
  try {
    await sequelize.authenticate();
    console.log('‚úÖ Connexion √† la base de donn√©es √©tablie avec succ√®s.');

    // S'assurer que les tables indispensables existent sans alt√©rer les existantes
    try {
      const { Atelier } = require('./models');
      if (Atelier && Atelier.sync) {
        await Atelier.sync(); // cr√©e la table si elle n'existe pas
        console.log('‚úÖ Table Ateliers v√©rifi√©e/cr√©√©e si n√©cessaire.');
      }
    } catch (syncErr) {
      console.error('‚ùå Erreur lors de la v√©rification/cr√©ation de la table Ateliers:', syncErr.message);
    }

    // Cr√©er un utilisateur admin par d√©faut
    await createDefaultUser();
    
    app.listen(PORT, () => {
      console.log(`üöÄ Serveur d√©marr√© sur http://localhost:${PORT}`);
      console.log(`üåç Environnement: ${process.env.NODE_ENV || 'd√©veloppement'}`);
    });
  } catch (error) {
    console.error('‚ùå Erreur lors du d√©marrage du serveur:', error.message);
    process.exit(1);
  }
};

// D√©marrer le serveur
startServer();

module.exports = app;
